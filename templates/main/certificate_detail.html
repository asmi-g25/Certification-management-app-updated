
{% extends "base.html" %}

{% block title %}Certificate {{ certificate.certificate_number }} - Certificate Management System{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-certificate"></i> Certificate {{ certificate.certificate_number }}</h1>
        <a href="{{ url_for('certificates') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Certificates
        </a>
    </div>
    
    <div class="row">
        <!-- Certificate Details -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Certificate Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Company Name:</strong> {{ certificate.application.company.name if certificate.application.company else 'N/A' }}</p>
                            <p><strong>Current Status:</strong> 
                                <span class="badge bg-{% if certificate.status == 'Active' %}success{% elif certificate.status == 'InActive' %}secondary{% elif certificate.status == 'Suspended' %}warning{% elif certificate.status == 'Withdrawn' %}info{% elif certificate.status == 'Cancelled' %}danger{% else %}primary{% endif %} fs-6">
                                    {{ certificate.status }}
                                </span>
                            </p>
                            <p><strong>Issue Date:</strong> {{ certificate.issued_date.strftime('%m/%d/%Y') if certificate.issued_date else 'N/A' }}</p>
                            <p><strong>Expiry Date:</strong> {{ certificate.expiry_date.strftime('%m/%d/%Y') if certificate.expiry_date else 'N/A' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Certification Number:</strong> {{ certificate.certificate_number }}</p>
                            <p><strong>Application Number:</strong> {{ certificate.application.application_number }}</p>
                            <p><strong>Description:</strong> {{ certificate.application.certificate_type or 'N/A' }}</p>
                            <p><strong>Generated By:</strong> {{ certificate.generated_by.full_name if certificate.generated_by else 'System' }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Certificate Document Upload -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-upload"></i> Certificate Document</h5>
                </div>
                <div class="card-body">
                    {% if certificate.certificate_file %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Certificate file uploaded: {{ certificate.certificate_file }}
                        <div class="mt-2">
                            <a href="{{ url_for('download_certificate', id=certificate.id) }}" class="btn btn-success btn-sm">
                                <i class="fas fa-download me-1"></i> Download Certificate
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Upload Area -->
                    <div class="upload-area border border-dashed p-4 text-center" style="border-color: var(--steel-blue) !important; border-radius: 8px; background-color: var(--warm-white);">
                        <form method="POST" action="{{ url_for('upload_certificate_file', id=certificate.id) }}" enctype="multipart/form-data" id="uploadForm">
                            <div class="mb-3">
                                <i class="fas fa-upload fa-3x mb-3" style="color: var(--steel-blue);"></i>
                                <h5>Upload Certificate PDF</h5>
                                <p class="text-muted">Drag and drop your PDF file here, or click to browse</p>
                            </div>
                            
                            <div class="mb-3">
                                <input type="file" class="form-control" id="certificate_file" name="certificate_file" 
                                       accept=".pdf" required style="display: none;">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('certificate_file').click();">
                                    Choose File
                                </button>
                            </div>
                            
                            <div class="selected-file d-none">
                                <div class="alert alert-info">
                                    <i class="fas fa-file-pdf me-2"></i>
                                    <span id="fileName"></span>
                                    <button type="submit" class="btn btn-success btn-sm ms-2">
                                        <i class="fas fa-upload me-1"></i> Upload
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Management and History -->
        <div class="col-md-4">
            <!-- Change Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-edit"></i> Change Status</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_certificate_status', id=certificate.id) }}">
                        <div class="mb-3">
                            <label for="status" class="form-label">New Status</label>
                            <select class="form-control" id="status" name="status" required>
                                <option value="">Select status...</option>
                                {% for status in ['Active', 'InActive', 'Withdrawn', 'Suspended', 'Cancelled'] %}
                                <option value="{{ status }}" {% if status == certificate.status %}disabled{% endif %}>
                                    {{ status }} {% if status == certificate.status %}(Current){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="reason" class="form-label">Reason for Change</label>
                            <textarea class="form-control" id="reason" name="reason" rows="3" 
                                     placeholder="Please provide a reason for the status change..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" onclick="return confirm('Are you sure you want to change the certificate status?')">
                            <i class="fas fa-save"></i> Update Status
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Certificate History -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Certificate History</h5>
                </div>
                <div class="card-body">
                    {% if status_history %}
                    <div class="timeline">
                        {% for entry in status_history %}
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-marker">
                                    <i class="fas fa-circle" style="color: var(--steel-blue); font-size: 0.5rem;"></i>
                                </div>
                                <div class="timeline-content ms-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <small class="text-muted">{{ entry.changed_at.strftime('%m/%d/%Y %H:%M') if entry.changed_at else 'N/A' }}</small>
                                    </div>
                                    <strong>Status changed from {{ entry.old_status }} to {{ entry.new_status }}</strong>
                                    {% if entry.changed_by %}
                                    <div><small class="text-muted">Changed by {{ entry.changed_by.full_name }}</small></div>
                                    {% endif %}
                                    {% if entry.reason %}
                                    <div class="mt-1">
                                        <small class="text-info"><strong>Reason:</strong> {{ entry.reason }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No status changes recorded.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('certificate_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const selectedFileDiv = document.querySelector('.selected-file');
    const fileNameSpan = document.getElementById('fileName');
    
    if (file) {
        fileNameSpan.textContent = file.name;
        selectedFileDiv.classList.remove('d-none');
    } else {
        selectedFileDiv.classList.add('d-none');
    }
});

// Drag and drop functionality
const uploadArea = document.querySelector('.upload-area');
const fileInput = document.getElementById('certificate_file');

uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.style.backgroundColor = 'var(--light-neutral)';
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.style.backgroundColor = 'var(--warm-white)';
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.style.backgroundColor = 'var(--warm-white)';
    
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type === 'application/pdf') {
        fileInput.files = files;
        fileInput.dispatchEvent(new Event('change'));
    } else {
        alert('Please select a PDF file.');
    }
});
</script>

<style>
.timeline-marker {
    width: 10px;
    padding-top: 4px;
}

.upload-area {
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.upload-area:hover {
    background-color: var(--light-neutral) !important;
}
</style>
{% endblock %}
